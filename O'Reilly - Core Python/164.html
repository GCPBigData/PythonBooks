
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Robots" content="INDEX,NOFOLLOW">
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<TITLE>Safari | Core Python Programming -&gt; *Creating Exceptions</TITLE>
<LINK REL="stylesheet" HREF="oreillyi/oreillyM.css">
</HEAD>
<BODY bgcolor="white" text="black" link="#990000" vlink="#990000" alink="#990000" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">

<table width="100%" cellpadding=5 cellspacing=0 border=0 class="navtopbg"><tr><td><font size="1"><p class="navtitle"><a href="1.html" class="navtitle">Programming</a> &gt; <a href="0130260363.html" class="navtitle">Core Python Programming</a> &gt; <a href="154.html" class="navtitle">10. Errors And Exceptions</a> &gt; <span class="nonavtitle">*Creating Exceptions</span></p></font></td><td align="right" valign="top" nowrap><font size="1"><a href="main.asp?list" class="safnavoff">See All Titles</a></font></td></tr></table>
<TABLE width=100% bgcolor=white border=0 cellspacing=0 cellpadding=5><TR><TD>
<TABLE border=0 width="100%" cellspacing=0 cellpadding=0><TR><td align=left width="15%" class="headingsubbarbg"><a href="163.html" title="Standard Exceptions"><font size="1">&lt;&nbsp;BACK</font></a></td><td align=center width="70%" class="headingsubbarbg"><font size="1"><a href="popanote.asp?pubui=oreilly&bookname=0130260363&snode=164" target="_blank" title="Make a public or private annnotation">Make Note</a> | <a href="164.html" title="Use a Safari bookmark to remember this section">Bookmark</a></font></td><td align=right width="15%" class="headingsubbarbg"><a href="165.html" title="Why Exceptions (Now)?"><font size="1">CONTINUE&nbsp;&gt;</font></a></td></TR></TABLE>
<a href="5%2F29%2F2002+9%3A29%3A35+PM.html" TABINDEX="-1"><img src=images/spacer.gif border=0 width=1 height=1></a><font color=white size=1>156135250194107072078175030179198180024228156016206217188240240204175192054105059111212080</font><a href="read4.asp?bookname=0130260363&snode=164&now=5%2F29%2F2002+9%3A29%3A35+PM" TABINDEX="-1"><img src=images/spacer.gif border=0 width=1 height=1></a><br>
<FONT>
				<h3>*Creating Exceptions</h3>
				<p>Although the set of standard exceptions is fairly wide-ranging, it may be advantageous to create your own exceptions. One situation is where you would like additional information from what a standard or module-specific exception provides. We will present two examples, both related to <tT CLAss="monofont">IOError.</tt></P>

				<P><TT clasS="monofont">IOError</TT> is a generic exception used for input/output problems which may arise from invalid file access or other forms of communication. Suppose we wanted to be more specific in terms of identifying the source of the problem. For example, for file errors, we want to have a <Tt class="monofont">FileError</tt> exception which behaves like <tt class="monofont">IOError,</tt> but with a name that has more meaning when performing file operations.</p>

				<p>Another exception we will look at is related to network programming with sockets. The exception generated by the <tT clAss="monofont">socket</tT> module is called <tt clAss="monofont">socket.error</tT> and is not a built-in exception. It is subclassed from the generic <TT Class="monofont">Exception</TT> exception. However, the exception arguments from <TT clasS="monofont">socket.error</TT> closely resemble those of <Tt claSS="monofont">IOError</TT> exceptions, so we are going to define a new exception called <tt class="monofont">NetworkError</tt> which subclasses from <tt class="monofont">IOError</tt> but contains at least the information provided by <tt ClaSs="monofont">socket.error.</tt></P>

				<p>Like classes and object-oriented programming, we have not formally covered network programming at this stage, but skip ahead to <a hrEf="249.html">Chapter 16</a> if you need to.</p>

				<P>We now present a module called myexc.py with our newly-customized exceptions <TT Class="monofont">FileError</TT> and <TT clasS="monofont">NetworkError.</TT> The code is in <A href="164#1.html">Example 10.3</A></P>

				
					<H5>
<A name="1"></a>Example 10.3. Creating Exceptions (<tt class="monofont">myexc.py</tt>)</h5>
					<p><b><i>This module defines two new exceptions,</i></b>
						<Tt cLass="monofont">FileError</Tt>
						<b><i>and</i></B>
						<tt cLASS="monofont">NetworkError,</tt>
						<b><i>as well as reimplements more diagnostic versions of</I></B>
						<TT clasS="monofont">open()</TT>
						<B><i>[</i></b><tT CLAss="monofont">myopen()</tt><b><i>]and</i></b>
						<tt class="monofont">socket.connect()</tt>
						<b><i>[</i></B><tt ClasS="monofont">myconnect()</tt><b><i>]. Also included is a test function [</I></b>
						<tt CLASs="monofont">test()</tt><b><I>] that is run if this module is executed directly.</I></B></P>

					<pre cLASS="monofont"> &lt;$nopage&gt;
001 1   #!/usr/bin/env python
002 2
003 3   <b>import</b>  os, socket, errno, types, tempfile
004 4
005 5   <b>class</b> NetworkError(IOError):
006 6        <B>pass</B> &lt;$nopage&gt;
007 7
008 8   <B>class</B> FileError(IOError):
009 9        <b>pass</b> &lt;$nopage&gt;
010 10
011 11  <b>def</b> updArgs(args, newarg=None):
012 12
013 13      <b>if</b> type(args) == types.InstanceType:
014 14          myargs = []
015 15          <b>for</b> eachArg in args:
016 16              myargs.append(eachArg)
017 17      <b>else:</b> &lt;$nopage&gt;
018 18          myargs = list(args)
019 19
020 20      <b>if</b> newarg:
021 21          myargs.append(newarg)
022 22
023 23      <b>return</b> tuple(myargs)
024 24
025 25  <b>def</b> fileArgs(file, mode, args):
026 26
027 27     <b>if</b> args[0] == errno.EACCES <b>and</b> \
028 28             'access' <B>in</b> dir(os):
029 29         perms = ''
030 30         permd = { 'r': os.R_OK, 'w': os.W_OK,
031 31             'x': os.X_OK}
032 32        pkeys = permd.keys()
033 33        pkeys.sort()
034 34        pkeys.reverse()
035 35
036 36        <b>for</B> eachPerm <b>in</b> 'rwx':
037 37            <b>if</B> os.access(file, permd[eachPerm]):
038 38                perms = perms + eachPerm
039 39            <b>else:</b> &lt;$nopage&gt;
040 40                perms = perms + '-'
041 41
042 42        <b>if</b> type(args) == types.InstanceType:
043 43            myargs = []
044 44            <B>for</b> eachArg <b>in</b> args:
045 45                myargs.append(eachArg)
046 46        <B>else:</B> &lt;$nopage&gt;
047 47            myargs = list(args)
048 48
049 49        myargs[1] = "'%s' %s (perms: '%s')" % \
050 50            (mode, myargs[1], perms)
051 51
052 52        myargs.append(args.filename)
053 53
054 54     <B>else:</B> &lt;$nopage&gt;
055 55         myargs = args
056 56
057 57     <b>return</b> tuple(myargs)
058 58
059 59 <b>def</b> myconnect(sock, host, port):
060 60
061 61     <B>try:</B> &lt;$nopage&gt;
062 62         sock.connect((host, port))
063 63
064 64     <B>except</B> socket.error, args:
065 65         myargs = updArgs(args)# conv inst2tuple
066 66         <b>if</b> len(myargs) == 1:# no #s on some errs
067 67             myargs = (errno.ENXIO, myargs[0])
068 68
069 69         <b>raise</b> NetworkError, \
070 70             updArgs(myargs, host + ':' + str(port))
071 71
072 72 <B>def</B> myopen(file, mode='r'):
073 73
074 74     <B>try:</B> &lt;$nopage&gt;
075 75         fo = open(file, mode)
076 76
077 77     <b>except</b> IOError, args:
078 78        <b>raise</b> FileError, fileArgs(file, mode, args)
079 79
080 80     <B>return</B> fo
081 81
082 82  <B>def</B> testfile():
083 83
084 84      file = mktemp()
085 85      f = open(file, 'w')
086 86      f.close()
087 87
088 88      <b>for</b> eachTest <b>in</b> ((0, 'r'), (0100, 'r'), \
089 89              0400, 'w'), (0500, 'w')):
090 90          <b>try:</b> &lt;$nopage&gt;
091 91              os.chmod(file, eachTest[0])
092 92              f = myopen(file, eachTest[1])
093 93
094 94          <b>except</b> FileError, args:
095 95              <b>print</b> "%s: %s" % \
096 96                  (args.__class__.__name__, args)
097 97          <b>else:</b> &lt;$nopage&gt;
098 98              <b>print</b> file, "opened ok… perm ignored"
099 99              f.close()
100 100
101 101     os.chmod(file, 0777)# enable all perms
102 102     os.unlink(file)
103 103
104 104 <b>def</b> testnet():
105 105     s = socket.socket(socket.AF_INET, \
106 106         socket.SOCK_STREAM)
107 107
108 108     <b>for</b> eachHost <b>in</b> ('deli', 'www'):
109 109          <B>try:</b> &lt;$nopage&gt;
110 110             myconnect(s, 'deli', 8080)
111 111          <b>except</B> NetworkError, args:
112 112             <b>print</b> "%s: %s" % \
113 113                  (args.__class__.__name__, args)
114 114
115 115 <b>if</B> __name__ == '__main__':
116 116     testfile()
117 117     testnet()
118  &lt;$nopage&gt;</pre>
				
				
					<h4>Lines 1 – 3</H4>
					<p>The Unix start-up script and importation of the <tt CLASs="monofont">socket, os, errno, types,</tt> and <tT CLAss="monofont">tempfile</tt> modules help us start this module.</P>

				
				
					<H4>Lines 5 – 9</H4>
					<P>Believe it or not, these five lines make up our new exceptions. Not just one, but both of them. Unless new functionality is going to be introduced, creating a new exception is just a matter of subclassing from an already-existing exception. In our case, that would be <tt clASS="monofont">IOError. EnvironmentError,</Tt> from which <tt class="monofont">IOError</tt> is derived would also work, but we wanted to convey that our exceptions were definitely I/O-related.</p>

					<p>We chose <tt class="monofont">IOError</tT> because it provides two arguments, an error number and an error string. File-related [uses <tt ClasS="monofont">open()</tt>] <tt ClasS="monofont">IOError</TT> exceptions even support a third argument which is not part of the main set of exception arguments, and that would be the file name. Special handling is done for this third argument which lives outside the main tuple pair and has the name <Tt claSS="monofont">filename.</TT></p>

				
				
					<h4>Lines 11 – 23</h4>
					<p>The entire purpose of the <TT CLass="monofont">updArgs()</tT> function is to "update" the exception arguments. What we mean here is that the original exception is going to provide us a set of arguments. We want to take these arguments and make them part of our new exception, perhaps embellishing or adding a third argument (which is not added if nothing is given— <TT Class="monofont">None</tt> is a default argument which we will study in the next chapter). Our goal is to provide the more informative details to the user so that if and when errors occur, the problems can be tracked down as quickly as possible.</p>

				
				
					<h4>Lines 25 – 57</h4>
					<p>The <tt class="monofont">fileArgs()</tt> function is used only by myopen() [see below]. In particular, we are seeking error <tT clAss="monofont">EACCES,</tT> which represents "permission denied." We pass all other <tt clAss="monofont">IOError</tT> exceptions along without modification (lines 54–55). If you are curious about <TT Class="monofont">ENXIO, EACCES,</TT> and other system error numbers, you can hunt them down by starting at file <TT clasS="monofont">/usr/include/sys/errno.h</TT> on a Unix system, or <Tt claSS="monofont">C:\Msdev\include\Errno.h</TT> if you are using Visual C++ on Windows.</p>

					<p>In line 27, we are also checking to make sure that the machine we are using supports the <tt class="monofont">os.access()</tt> function, which helps you check what kind of file permissions you have for any particular file. We do not proceed unless we receive both a permission error as well as the ability to check what kind of permissions we have. If all checks out, we set up a dictionary to help us build a string indicating the permissions we have on our file.</p>

					<p>The Unix file system uses explicit file permissions for the user, group (more than one user can belong to a "group"), and other (any user other than the owner or someone in the same group as the owner) in read, write, and execute ('r', 'w', 'x') order. Windows supports some of these permissions.</p>

					<p>Now it is time to build the permission string. If the file has a permission, its corresponding letter shows up in the string, otherwise a dash ( <tt claSs="monofont">-</tT> ) appears. For example, a string of <tt cLass="monofont">"rw-"</tT> means that you have read and write access to it. If the string reads <tt cLASS="monofont">"r-x",</tt> you have only read and execute access; <tt CLASs="monofont">"---"</tt> means no permission at all.</p>

					<P>After the permission string has been constructed, we create a temporary argument list. We then alter the error string to contain the permission string, something which standard <TT Class="monofont">IOError</TT> exception does not provide. "Permission denied" sometimes seems silly if the system does not tell you what permissions you have to correct the problem. The reason, of course, is security. When intruders do not have permission to access something, the last thing you want them to see is what the file permissions are, hence the dilemma. However, our example here is merely an exercise, so we allow for the temporary "breach of security." The point is to verify whether or not the <TT class="monofont">os.chmod()</tt> functions call affected file permissions the way they are supposed to.</p>

					<p>The final thing we do is to add the file name to our argument list and return the set of arguments as a tuple.</p>

				
				
					<h4>Lines 59 – 70</h4>
					<p>Our new <tt class="monofont">myconnect()</Tt> function simply wraps the standard socket method <tT claSs="monofont">connect()</tt> to provide an <tT claSS="monofont">IOError-</TT>type exception if the network connection fails. Unlike the general <tt clASS="monofont">socket.error</Tt> exception, we also provide the host name and port number as an added value to the programmer.</p>

					<p>For those new to network programming, a host name and port number pair are analogous to an area code and telephone number when you are trying to contact someone. In this case, we are trying to contact a program running on the remote host, presumably a server of some sort; therefore, we require the host's name and the port number that the server is listening on.</p>

					<P>When a failure occurs, the error number and error string are quite helpful, but it would be even more helpful to have the exact host-port combination as well, since this pair may be dynamically-generated or retrieved from some database or name service. That is the value-add we are bestowing to our version of <TT Class="monofont">connect().</TT> Another issue arises when a host cannot be found. There is no direct error number given to us by the <TT class="monofont">socket.error</tt> exception, so to make it conform to the <tt class="monofont">IOError</tt> protocol of providing an error number-error string pair, we find the closest error number that matches. We choose <tt clAss="monofont">ENXIO.</Tt></p>

				
				
					<h4>Lines 72 – 80</H4>
					<p>Like its sibling <tt cLass="monofont">myconnect(), myopen()</TT> also wraps around an existing piece of code. Here, we have the <TT clasS="monofont">open()</TT> function. Our handler catches only <Tt claSS="monofont">IOError</TT> exceptions. All others will pass through and on up to the next level (when no handler is found for them). Once an <b><tt cLASS="monofont">IOError</tt></b> is caught, we raise our own error and customized arguments as returned from <tt class="monofont">fileArgs().</tt></p>

				
				
					<h4>Lines 82 – 102</h4>
					<p>We shall perform the file testing first, here using the <tt clAss="monofont">testfile()</Tt> function. In order to begin, we need to create a test file that we can manipulate by changing its permissions to generate permission errors. The <tt Class="monofont">tempfile</Tt> module contains code to create temporary file names or temporary files themselves. We just need the name for now and use our new <tt CLASs="monofont">myopen()</tt> function to create an empty file. Note that if an error occurred here, there would be no handler, and our program would terminate fatally—the test program should not continue if we cannot even <i>create</I> a test file.</P>

					<P>Our test uses four different permission configurations. A zero means no permissions at all, 0100 means execute-only, 0400 indicates read-only, and 0500 means read- and execute-only (0400 + 0100). In all cases, we will attempt to open a file with an invalid mode. The <Tt claSS="monofont">os.chmod()</TT> function is responsible for updating a file's permission modes. (NOTE: these permissions all have a leading zero in front, indicating that they are octal [base 8] numbers.)</p>

					<p>If an error occurs, we want to display diagnostic information similar to the way the Python interpreter performs the same task when uncaught exceptions occur, and that is giving the exception name followed by its arguments. The <tt CLASs="monofont">__class__</tt> special variable provides the class object for which an instance was created from. Rather than displaying the entire class name here (<tt class="monofont">myexc.FileError</tt>), we use the class object's <tt class="monofont">__name__</tT> variable to just display the class name (<tt ClasS="monofont">FileError</tt>), which is also what you see from the interpreter in an unhandled error situation. Then the arguments which we arduously put together in our wrapper functions follow.</p>

					<p>If the file opened successfully, that means the permissions were ignored for some reason. We indicate this with a diagnostic message and close the file. Once all tests have been completed, we enable all permissions for the file and remove it with the <Tt clASS="monofont">os.unlink()</Tt> function. <tt cLASS="monofont">os.remove()</tt> is equivalent to <tt CLASs="monofont">os.unlink().</tt>)</p>

				
				
					<H4>Lines 104 – 113</H4>
					<P>The next section of code (<Tt class="monofont">testnet()</tt>) tests our <tt class="monofont">NetworkError</tt> exception. A socket is a communication endpoint with which to establish contact with another host. We create such an object, then use it in an attempt to connect to a host with no server to accept our connect request and a host not on our network.</p>

				
				
					<h4>Lines 115 – 117</h4>
					<P>We want to execute our <tt ClasS="monofont">test*()</tt> functions only when invoking this script directly, and that is what the code here does. Most of the scripts given in this text utilize the same format.</p>

					<p>Running this on a Unix machine, we get the following output:</P>

					<pre>
						
% myexc.py
FileError: [Errno 13] 'r' Permission denied (perms: '---'):
 '/usr/tmp/@18908.1'
FileError: [Errno 13] 'r' Permission denied (perms: '--x'):
 '/usr/tmp/@18908.1'
FileError: [Errno 13] 'w' Permission denied (perms: 'r--'):
 '/usr/tmp/@18908.1'
FileError: [Errno 13] 'w' Permission denied (perms: 'r-x'):
 '/usr/tmp/@18908.1'
NetworkError: [Errno 146] Connection refused: 'deli:8080'
NetworkError: [Errno 6] host not found: 'www:8080'

					</PRE>

					<P>The results are slightly different on a Windows machine:</p>

					<pre>
						
D:\python&gt;python myexc.py
C:\WINDOWS\TEMP\~-195619-1 opened ok… perms ignored
C:\WINDOWS\TEMP\~-195619-1 opened ok… perms ignored
FileError: [Errno 13] 'w' Permission denied (perms: 'r–x'):
 'C:\\WINDOWS\\TEMP\\~-195619-1'
FileError: [Errno 13] 'w' Permission denied (perms: 'r–x'):
 'C:\\WINDOWS\\TEMP\\~-195619-1'
NetworkError: [Errno 10061] winsock error: 'deli:8080'
NetworkError: [Errno 6] host not found: 'www:8080'

					</PRE>

					<P>You will notice that Windows does not support read permissions on files, which is the reason why the first two file open attempts succeeded. Your mileage may vary (YMMV) on your own machine and operating system.</p>

				
			</fonT>
<P><TABLE width="100%" border=0><TR valign="top"><TD><font size=1 color="#C0C0C0"><br></font></TD><TD align=right><font size=1 color="#C0C0C0">Last updated on 9/14/2001<br>Core Python Programming, &copy;&nbsp;2002 Prentice Hall PTR</font></TD></TR></TABLE></P>
<TABLE border=0 width="100%" cellspacing=0 cellpadding=0><TR><td align=left width="15%" class="headingsubbarbg"><a href="163.html" title="Standard Exceptions"><font size="1">&lt;&nbsp;BACK</font></a></td><td align=center width="70%" class="headingsubbarbg"><font size="1"><a href="popanote.asp?pubui=oreilly&bookname=0130260363&snode=164" target="_blank" title="Make a public or private annnotation">Make Note</a> | <a href="164.html" title="Use a Safari bookmark to remember this section">Bookmark</a></font></td><td align=right width="15%" class="headingsubbarbg"><a href="165.html" title="Why Exceptions (Now)?"><font size="1">CONTINUE&nbsp;&gt;</font></a></td></TR></TABLE>
</TD></TR></TABLE>




<!--EndOfBrowse-->

</TD></TR></TABLE>
<table width=100% border=0 cellspacing=0 cellpadding=0 bgcolor=#990000><tr><td><p align=center><font size=1 face="verdana,arial,helvetica" color=white>© 2002, O'Reilly & Associates, Inc.</font></p></td></tr></table>
</BODY>
</HTML>